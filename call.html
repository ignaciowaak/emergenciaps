<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Unirse a Sala</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: sans-serif; margin: 1rem; }
    h2 { color: #007AFF; }
    input, button { padding: .5rem; margin: .5rem 0; }
    input { width: 100%; max-width: 300px; border: 1px solid #ccc; border-radius: 5px; }
    button { background: #007AFF; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
    audio { display: block; margin-top: 1rem; width: 100%; max-width: 300px; }
  </style>
</head>
<body>
  <h2>Ingresar a Sala</h2>
  <input type="text" id="joinInput" placeholder="Código de sala">
  <button id="joinBtn">Unirse</button>
  <audio id="remoteAudioJoin" controls autoplay hidden></audio>  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, get, set, push, onChildAdded } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    // --- Configuración Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyA_USvfSXAqZf7hQhJCon0WulnrrINB7cI",
      authDomain: "the-pic-c437e.firebaseapp.com",
      databaseURL: "https://the-pic-c437e-default-rtdb.firebaseio.com",
      projectId: "the-pic-c437e",
      storageBucket: "the-pic-c437e.appspot.com",
      messagingSenderId: "750954597180",
      appId: "1:750954597180:web:d7b67c6b60f4d3bb17ec39"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const iceConfig = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" }
      ]
    };

    let pc, localStream, roomCode = "";
    const joinInput   = document.getElementById("joinInput");
    const joinBtn     = document.getElementById("joinBtn");
    const remoteAudio = document.getElementById("remoteAudioJoin");

    async function initLocal() {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    }

    function createPC() {
      pc = new RTCPeerConnection(iceConfig);
      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      pc.ontrack = e => {
        remoteAudio.hidden = false;
        remoteAudio.srcObject = e.streams[0];
      };

      pc.onicecandidate = e => {
        if (e.candidate)
          push(ref(db, `calls/${roomCode}/calleeCandidates`), JSON.stringify(e.candidate));
      };
    }

    joinBtn.onclick = async () => {
      try {
        await initLocal();
        roomCode = joinInput.value.trim();
        if (!roomCode) return alert("Ingresa el código de la sala.");
        joinBtn.disabled = true;
        createPC();

        const offerSnap = await get(ref(db, `calls/${roomCode}/offer`));
        if (!offerSnap.exists()) return alert("Sala no existe.");
        await pc.setRemoteDescription(JSON.parse(offerSnap.val()));

        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await set(ref(db, `calls/${roomCode}/answer`), JSON.stringify(answer));

        onChildAdded(ref(db, `calls/${roomCode}/callerCandidates`), async snap => {
          await pc.addIceCandidate(new RTCIceCandidate(JSON.parse(snap.val())));
        });
      } catch (err) {
        console.error(err);
        alert("Error al unirse a la sala.");
      }
    };
  </script></body>
</html>