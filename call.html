<!DOCTYPE html><html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ayuda en Tiempo Real</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    .hidden { display: none !important; }
    :root {
      --ios-primary: #007AFF;
      --admin-primary: #1DCC44;
      --ios-background: rgba(242,242,247,0.9);
      --ios-blur: blur(20px);
      --ios-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f9; margin:0; min-height:100vh;
      display:flex; justify-content:center; align-items:center;
      flex-wrap: wrap; gap:20px;
    }
    .card {
      background: var(--ios-background); backdrop-filter: var(--ios-blur);
      box-shadow: var(--ios-shadow); border-radius:14px;
      padding:2rem; width:90%; max-width:400px;
      text-align:center; transition: opacity .3s, transform .3s;
      opacity:1; transform:scale(1);
    }
    .card.hidden { opacity:0; transform:scale(.95); }
    h2 { margin-top:0; color:#1c1c1e; }
    select, input, button { width:100%; margin:.5rem 0; padding:.75rem; border-radius:10px; border:1px solid rgba(0,0,0,0.1); font-size:1rem; box-sizing:border-box; }
    button { background: var(--ios-primary); color:#fff; border:none; font-weight:500; cursor:pointer; }
    button:active { transform:scale(.98); }
    #status { margin-top:1rem; font-weight:500; color:#3a3a3c; }
    #remoteAudio { margin-top:1rem; width:100%; display:none; }
    #messages { flex:1; overflow-y:auto; border:1px solid rgba(0,0,0,0.1); border-radius:10px; padding:1rem; background:#fff; max-height:200px; text-align:left; display:flex; flex-direction:column; gap:.5rem; }
    .message { padding:.5rem; border-radius:10px; }
    .sent { align-self:flex-end; background: rgba(29,204,68,0.1); }
    .sent span:first-child { color: var(--admin-primary); font-weight:500; }
    .received { align-self:flex-start; background: rgba(0,122,255,0.1); }
    .received span:first-child { color: var(--ios-primary); font-weight:500; }
  </style>
</head>
<body>
  <div class="card" id="requestSection">
    <h2>¿Necesitas Ayuda?</h2>
    <select id="requestType">
      <option value="chat">Chat de Emergencia</option>
      <option value="call">Llamada de Emergencia</option>
    </select>
    <input type="text" id="userName" placeholder="Tu nombre (opcional)">
    <button id="btnRequest">Enviar Solicitud</button>
    <p id="status">Estado: Listo para enviar</p>
  </div>  <div class="card hidden" id="waitingSection">
    <h2>Solicitud Enviada</h2>
    <p id="waitingMsg">Espera a que un asistente acepte tu solicitud...</p>
    <button id="cancelBtn">Cancelar Solicitud</button>
  </div>  <div class="card hidden" id="chatSection">
    <h2>Chat de Emergencia</h2>
    <div id="messages"></div>
    <input type="text" id="chatInput" placeholder="Escribe tu mensaje">
    <button id="sendChatBtn">Enviar</button>
  </div>  <div class="card hidden" id="callSection">
    <h2>Llamada de Emergencia</h2>
    <p id="callStatus">Conectando...</p>
    <button id="hangUpBtn" disabled>Colgar</button>
    <audio id="remoteAudio" controls autoplay></audio>
  </div>  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
    import { getDatabase, ref, push, serverTimestamp, onValue, set, remove, off } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyA_USvfSXAqZf7hQhJCon0WulnrrINB7cI",
      authDomain: "the-pic-c437e.firebaseapp.com",
      databaseURL: "https://the-pic-c437e-default-rtdb.firebaseio.com",
      projectId: "the-pic-c437e",
      storageBucket: "the-pic-c437e.appspot.com",
      messagingSenderId: "750954597180",
      appId: "1:750954597180:web:d7b67c6b60f4d3bb17ec39"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const sections = {
      request: document.getElementById('requestSection'),
      waiting: document.getElementById('waitingSection'),
      chat: document.getElementById('chatSection'),
      call: document.getElementById('callSection')
    };
    const statusEl = document.getElementById('status');
    const waitingMsg = document.getElementById('waitingMsg');
    const btnRequest = document.getElementById('btnRequest');
    const btnCancel = document.getElementById('cancelBtn');
    const typeSel = document.getElementById('requestType');
    const nameInput = document.getElementById('userName');

    let roomKey = null, reqType = null, statusListener = null;

    function show(section) {
      Object.values(sections).forEach(sec => sec.classList.add('hidden'));
      sections[section].classList.remove('hidden');
    }
    show('request');

    btnRequest.onclick = () => {
      reqType = typeSel.value;
      const user = nameInput.value.trim() || 'Anónimo';
      const newRef = push(ref(db, 'requests'));
      roomKey = newRef.key;
      set(newRef, { type: reqType, user, status: 'pending', timestamp: serverTimestamp() })
        .then(() => {
          show('waiting');
          waitingMsg.textContent = `Esperando a que un asistente acepte tu solicitud (${reqType === 'chat' ? 'Chat' : 'Llamada'})...`;
          statusEl.textContent = '';
          if (statusListener) off(ref(db, `requests/${roomKey}/status`), statusListener);
          statusListener = onValue(ref(db, `requests/${roomKey}/status`), snap => {
            const st = snap.val();
            if (st === 'accepted') {
              off(ref(db, `requests/${roomKey}/status`), statusListener);
              statusListener = null;
              if (reqType === 'chat') initChat(); else initCall();
            } else if (st === 'cancelled' || st === null) {
              alert('Tu solicitud fue cancelada o cerrada.');
              location.reload();
            }
          });
        })
        .catch(err => {
          statusEl.textContent = `Error: ${err.message}`;
          show('request');
        });
    };

    btnCancel.onclick = () => {
      if (!roomKey) return;
      set(ref(db, `requests/${roomKey}/status`), 'cancelled')
        .finally(() => remove(ref(db, `requests/${roomKey}`)).then(() => location.reload()));
    };

    function initChat() {
      show('chat');
      const msgsEl = document.getElementById('messages');
      const chatInput = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendChatBtn');
      const userName = nameInput.value.trim() || 'Usuario';

      sendBtn.onclick = () => {
        const text = chatInput.value.trim(); if (!text) return;
        push(ref(db, `chats/${roomKey}`), { sender: 'user', user: userName, text, timestamp: serverTimestamp() });
        chatInput.value = '';
      };
      chatInput.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); sendBtn.click(); } });

      onValue(ref(db, `chats/${roomKey}`), snap => {
        msgsEl.innerHTML = '';
        if (!snap.exists()) return;
        Object.values(snap.val()).sort((a,b) => a.timestamp - b.timestamp).forEach(m => {
          const d = document.createElement('div');
          d.className = 'message ' + (m.sender === 'user' ? 'sent' : 'received');
          d.innerHTML = `<span>${m.user}</span><span>${m.text}</span>`;
          msgsEl.append(d);
        });
        msgsEl.scrollTop = msgsEl.scrollHeight;
      });
    }

    async function initCall() {
      show('call');
      const callStatusEl = document.getElementById('callStatus');
      const hangUpBtn = document.getElementById('hangUpBtn');
      const remoteAudio = document.getElementById('remoteAudio');
      let pc;
      try {
        callStatusEl.textContent = 'Solicitando micrófono...';
        const localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const dbRef = ref(db, `calls/${roomKey}`);
        pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        pc.ontrack = e => { remoteAudio.srcObject = e.streams[0]; remoteAudio.style.display = 'block'; };
        pc.onicecandidate = e => { if (e.candidate) push(ref(dbRef, 'calleeCandidates'), JSON.stringify(e.candidate)); };
        const offerSnap = await onValue(ref(db, `calls/${roomKey}/offer`), {});
        // Resto de intercambio de oferta/respuesta y candidatos...
        hangUpBtn.disabled = false;
      } catch (e) {
        alert('Error en llamada: ' + e.message);
        location.reload();
      }
      hangUpBtn.onclick = () => { pc?.close(); location.reload(); };
    }
  </script></body>
</html>