<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Llamada de Voz Segura</title>
  <style>
    body { font-family: sans-serif; margin: 1rem; }
    h2 { color: #007AFF; }
    .section { margin-bottom: 1.5rem; }
    input { padding: .5rem; border-radius: 5px; border: 1px solid #ccc; width: 200px; }
    button { padding: .5rem 1rem; margin-left: .5rem; border: none; border-radius: 5px;
             background: #007AFF; color: #fff; cursor: pointer; }
    button:disabled { background: #aaa; cursor: default; }
    #status { margin-top: 1rem; font-weight: bold; }
  </style>
</head>
<body>

  <h2>Llamada de Ayuda</h2>

  <div class="section">
    <h3>1. Crear Sala (asistente)</h3>
    <input type="text" id="createCode" placeholder="C√≥digo √∫nico">
    <button id="btnCreate">Crear sala</button>
  </div>

  <div class="section">
    <h3>2. Unirse a Sala (usuario)</h3>
    <input type="text" id="joinCode" placeholder="C√≥digo recibido">
    <button id="btnJoin">Unirse a sala</button>
  </div>

  <div class="section">
    <button id="btnHangup" disabled>Finalizar Llamada</button>
    <p id="status">Estado: Esperando acci√≥n...</p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getDatabase, ref, set, push, onValue,
      onChildAdded, get, remove
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    // --- Configuraci√≥n Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyA_USvfSXAqZf7hQhJCon0WulnrrINB7cI",
      authDomain: "the-pic-c437e.firebaseapp.com",
      databaseURL: "https://the-pic-c437e-default-rtdb.firebaseio.com",
      projectId: "the-pic-c437e",
      storageBucket: "the-pic-c437e.appspot.com",
      messagingSenderId: "750954597180",
      appId: "1:750954597180:web:d7b67c6b60f4d3bb17ec39"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- ICE servers robustos (STUN + TURN) ---
    // REEMPLAZA los datos de TURN con tu servidor TURN real
    const iceConfig = {
      iceServers: [
        { urls: "stun:stun.l.google.com:19302" },
        {
          urls: "turn:TU_SERVIDOR_TURN:3478",
          username: "TU_USUARIO_TURN",
          credential: "TU_CREDENCIAL_TURN"
        }
      ]
    };

    // --- Variables WebRTC ---
    let pc;
    let localStream;
    let roomCode = "";
    let isCaller = false;

    // Referencias a DOM
    const btnCreate = document.getElementById("btnCreate");
    const btnJoin   = document.getElementById("btnJoin");
    const btnHangup = document.getElementById("btnHangup");
    const statusEl  = document.getElementById("status");

    // Obtener audio local y preparar stream
    async function initLocalStream() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
      } catch (e) {
        alert("No se pudo acceder al micr√≥fono. Revisa permisos.");
        throw e;
      }
    }

    // Crea nueva instancia de RTCPeerConnection y agrega handlers
    function createPeerConnection() {
      pc = new RTCPeerConnection(iceConfig);

      // Agregar audio local
      if (localStream) {
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      }

      // Reproducir audio remoto
      pc.ontrack = e => {
        const audio = new Audio();
        audio.srcObject = e.streams[0];
        audio.play().catch(console.error);
      };

      // ICE candidates
      pc.onicecandidate = e => {
        if (e.candidate && roomCode) {
          const path = isCaller
            ? `calls/${roomCode}/callerCandidates`
            : `calls/${roomCode}/calleeCandidates`;
          push(ref(db, path), JSON.stringify(e.candidate))
            .catch(err => console.error("Error push ICE:", err));
        }
      };

      // Monitoreo de estado ICE
      pc.oniceconnectionstatechange = () => {
        console.log("ICE state:", pc.iceConnectionState);
        if (pc.iceConnectionState === "failed" || pc.iceConnectionState === "disconnected") {
          status("Error de conexi√≥n. Reinicia la llamada.");
          btnHangup.disabled = false;
        }
      };
    }

    // Actualiza estado en UI
    function status(text) {
      statusEl.textContent = "Estado: " + text;
    }

    // Habilita/deshabilita botones
    function toggleButtons(disabled) {
      btnCreate.disabled = disabled;
      btnJoin.disabled   = disabled;
    }

    // Reinicia todo para nueva llamada
    function reset() {
      if (pc) pc.close();
      roomCode = "";
      isCaller = false;
      toggleButtons(false);
      btnHangup.disabled = true;
      status("Esperando acci√≥n...");
      createPeerConnection();
    }

    // Crear sala (caller)
    btnCreate.onclick = async () => {
      try {
        await initLocalStream();
        isCaller = true;
        roomCode = document.getElementById("createCode").value.trim();
        if (!roomCode) return alert("Ingresa un c√≥digo para la sala.");
        toggleButtons(true);
        status("Creando sala‚Ä¶");
        createPeerConnection();

        // Crear offer
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await set(ref(db, `calls/${roomCode}/offer`), JSON.stringify(offer));

        // Escuchar answer
        onValue(ref(db, `calls/${roomCode}/answer`), async snap => {
          if (!snap.exists()) return;
          const ans = JSON.parse(snap.val());
          await pc.setRemoteDescription(ans);
          status("Conectado üéâ");
          btnHangup.disabled = false;
        });

        // Escuchar candidatos del callee
        onChildAdded(ref(db, `calls/${roomCode}/calleeCandidates`),
          async snap => {
            const cand = new RTCIceCandidate(JSON.parse(snap.val()));
            await pc.addIceCandidate(cand);
          });

        status("Sala creada. Esperando conexi√≥n‚Ä¶");
      } catch (err) {
        console.error(err);
        alert("Error al crear sala.");
        reset();
      }
    };

    // Unirse a sala (callee)
    btnJoin.onclick = async () => {
      try {
        await initLocalStream();
        isCaller = false;
        roomCode = document.getElementById("joinCode").value.trim();
        if (!roomCode) return alert("Ingresa el c√≥digo de la sala.");
        toggleButtons(true);
        status("Uni√©ndose a sala‚Ä¶");
        createPeerConnection();

        // Obtener offer
        const offerSnap = await get(ref(db, `calls/${roomCode}/offer`));
        if (!offerSnap.exists()) {
          alert("Sala no encontrada.");
          reset();
          return;
        }
        const offer = JSON.parse(offerSnap.val());
        await pc.setRemoteDescription(offer);

        // Crear y enviar answer
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        await set(ref(db, `calls/${roomCode}/answer`), JSON.stringify(answer));

        // Escuchar candidatos del caller
        onChildAdded(ref(db, `calls/${roomCode}/callerCandidates`),
          async snap => {
            const cand = new RTCIceCandidate(JSON.parse(snap.val()));
            await pc.addIceCandidate(cand);
          });

        status("Conectando‚Ä¶");
        btnHangup.disabled = false;
      } catch (err) {
        console.error(err);
        alert("Error al unirse a la sala.");
        reset();
      }
    };

    // Colgar llamada
    btnHangup.onclick = () => {
      pc.close();
      remove(ref(db, `calls/${roomCode}`));
      status("Llamada finalizada.");
      reset();
    };

    // Inicializaci√≥n
    createPeerConnection();
  </script>
</body>
</html>